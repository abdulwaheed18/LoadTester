<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Tester Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .metric-card { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .metric-title { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .metric-value { font-size: 1.5rem; font-weight: 600; color: #111827; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .status-running { background-color: #d1fae5; color: #065f46; }
        .status-stopped { background-color: #fee2e2; color: #991b1b; }
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 0.375rem; overflow: hidden; height: 1rem; margin-top: 0.5rem;}
        .progress-bar { height: 100%; text-align: center; line-height: 1rem; color: white; font-size: 0.75rem;}
        .progress-bar-success { background-color: #22c55e; } /* green-500 */
        .progress-bar-failure { background-color: #ef4444; } /* red-500 */
        .history-link { margin-top: 1rem; display: inline-block; background-color: #60a5fa; color:white; padding: 0.5rem 1rem; border-radius:0.375rem; text-decoration: none; }
        .history-link:hover { background-color: #3b82f6; }
        .config-section { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .config-title { font-size: 1.125rem; font-semibold; color: #1f2937; margin-bottom: 0.75rem;}
        .config-item { margin-bottom: 0.5rem; font-size: 0.875rem; }
        .config-label { font-weight: 500; color: #374151; }
        .target-card { border: 1px solid #d1d5db; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; background-color: white;}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

<div class="max-w-7xl mx-auto">
    <header class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Load Tester Dashboard</h1>
            <p class="text-gray-600">Control and monitor your load tests in real-time.</p>
        </div>
        <div>
            <a href="/history" class="history-link">View Test History</a>
        </div>
    </header>

    <!-- Configuration Display Section -->
    <div id="configDisplaySection" class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Current Configuration</h2>
        <div id="configDetails">
            <p class="text-gray-500">Loading configuration...</p>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">Test Control</h2>
        <div class="flex space-x-4 items-center mb-2">
            <button id="startButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out disabled:opacity-50">
                Start Test
            </button>
            <button id="stopButton"
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out disabled:opacity-50">
                Stop Test
            </button>
            <div class="ml-auto">
                <span class="text-sm font-medium mr-2">Status:</span>
                <span id="testStatusBadge" class="status-badge">Initializing...</span>
            </div>
        </div>
        <div class="text-sm text-gray-500">
            Current Run ID: <span id="currentRunIdLabel" class="font-mono">N/A</span>
        </div>
        <div id="messageArea" class="mt-4 text-sm text-gray-700"></div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Live Metrics</h2>
        <div id="metricsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="noMetricsMessage" class="text-gray-500 col-span-full">
                Metrics will appear here once the test is running or has completed a cycle.
            </p>
        </div>
    </div>
</div>

<script>
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const testStatusBadge = document.getElementById('testStatusBadge');
    const metricsContainer = document.getElementById('metricsContainer');
    const messageArea = document.getElementById('messageArea');
    const noMetricsMessage = document.getElementById('noMetricsMessage');
    const currentRunIdLabel = document.getElementById('currentRunIdLabel');
    const configDetailsContainer = document.getElementById('configDetails');


    let statusInterval;
    let metricsInterval;

    async function fetchTestConfig() {
        try {
            const response = await fetch('/api/loadtest/config');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const config = await response.json();
            renderTestConfig(config);
        } catch (error) {
            console.error('Error fetching test configuration:', error);
            configDetailsContainer.innerHTML = `<p class="text-red-500">Error loading configuration: ${error.message}</p>`;
        }
    }

    function renderTestConfig(config) {
        if (!config || Object.keys(config).length === 0) {
            configDetailsContainer.innerHTML = '<p class="text-gray-500">No configuration data available.</p>';
            return;
        }
        if (config.error) {
             configDetailsContainer.innerHTML = `<p class="text-red-500">Error loading configuration: ${config.error}</p>`;
            return;
        }

        let html = `<div class="config-section">`;
        html += `<div class="config-item"><span class="config-label">Run Duration:</span> ${config.runDurationMinutesConfigured > 0 ? config.runDurationMinutesConfigured + ' minutes' : 'Indefinite'}</div>`;
        html += `<div class="config-item"><span class="config-label">Periodic Reporting:</span> ${config.periodicReportingEnabled ? 'Enabled (Every ' + (config.periodicReportIntervalMs/1000) + 's)' : 'Disabled'}</div>`;
        html += `<div class="config-item"><span class="config-label">History Directory:</span> <span class="font-mono text-xs">${config.historyDirectory || 'N/A'}</span></div>`;
        html += `</div>`;

        if (config.targets && config.targets.length > 0) {
            html += `<h3 class="config-title mt-4">Targets (${config.targets.length}):</h3>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            config.targets.forEach(target => {
                html += `<div class="target-card">
                            <p class="font-semibold text-blue-600">${target.name}</p>
                            <p class="text-xs text-gray-600 truncate" title="${target.url}">${target.method} - ${target.url}</p>
                            <p class="text-xs"><span class="config-label">Desired TPS:</span> ${target.desiredTps === 0 ? 'Max Effort' : target.desiredTps}</p>
                            <p class="text-xs"><span class="config-label">Throttle Interval:</span> ${target.throttleIntervalMs} ms</p>
                            <p class="text-xs"><span class="config-label">Has Payload:</span> ${target.hasPayload ? 'Yes' : 'No'}</p>
                         </div>`;
            });
            html += `</div>`;
        } else {
            html += '<p class="text-gray-500 mt-2">No targets configured.</p>';
        }
        configDetailsContainer.innerHTML = html;
    }


    async function updateTestRunningStatus() {
        try {
            const response = await fetch('/api/loadtest/isrunning');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.running) {
                testStatusBadge.textContent = 'Running';
                testStatusBadge.className = 'status-badge status-running';
                startButton.disabled = true;
                stopButton.disabled = false;
                currentRunIdLabel.textContent = data.currentRunId || 'N/A';
            } else {
                testStatusBadge.textContent = 'Stopped';
                testStatusBadge.className = 'status-badge status-stopped';
                startButton.disabled = false;
                stopButton.disabled = true;
                currentRunIdLabel.textContent = 'N/A';
            }
        } catch (error) {
            console.error('Error fetching running status:', error);
            testStatusBadge.textContent = 'Error';
            testStatusBadge.className = 'status-badge status-stopped';
            showMessage(`Error updating status: ${error.message}`, 'error');
        }
    }

    async function fetchMetrics() {
        try {
            const response = await fetch('/api/loadtest/status');
             if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const metrics = await response.json();
            renderMetrics(metrics);
        } catch (error) {
            console.error('Error fetching metrics:', error);
            showMessage(`Error fetching metrics: ${error.message}`, 'error');
             if (noMetricsMessage) noMetricsMessage.textContent = 'Could not fetch metrics. See console for errors.';
        }
    }

    function renderMetrics(targets) {
        metricsContainer.innerHTML = '';
        if (!targets || targets.length === 0) {
            if (noMetricsMessage) {
                metricsContainer.appendChild(noMetricsMessage);
                noMetricsMessage.style.display = 'block';
                noMetricsMessage.textContent = 'No metrics data available yet. Start the test or wait for data.';
            }
            return;
        }
        if (noMetricsMessage) noMetricsMessage.style.display = 'none';

        targets.forEach(target => {
            const card = document.createElement('div');
            card.className = 'metric-card shadow-lg';
            const totalCompleted = target.successfulRequests + target.failedRequests;
            const successPercentage = totalCompleted > 0 ? (target.successfulRequests / totalCompleted) * 100 : 0;
            const failurePercentage = totalCompleted > 0 ? (target.failedRequests / totalCompleted) * 100 : 0;

            card.innerHTML = `
                <h3 class="text-lg font-semibold text-blue-700 mb-3">${target.name}</h3>
                <p class="text-xs text-gray-500 truncate mb-2" title="${target.url}">${target.method} - ${target.url}</p>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-3">
                    <div><span class="font-medium">Desired TPS:</span> ${target.desiredTps === 0 ? 'Max Effort' : target.desiredTps}</div>
                    <div><span class="font-medium">Initiated:</span> ${formatNumber(target.initiatedRequests)}</div>
                    <div><span class="font-medium text-green-600">Successful:</span> ${formatNumber(target.successfulRequests)}</div>
                    <div><span class="font-medium text-red-600">Failed:</span> ${formatNumber(target.failedRequests)}</div>
                    <div><span class="font-medium">Throttled:</span> ${formatNumber(target.throttledRequests)}</div>
                    <div><span class="font-medium">Dropped (BP):</span> ${formatNumber(target.backpressureDroppedRequests)}</div>
                </div>
                ${target.latencyData ? `
                    <div class="text-sm mb-3">
                        <strong>Latency (ms):</strong> Avg: ${formatNumber(target.latencyData.avg, 2)}, Max: ${formatNumber(target.latencyData.max, 2)}, Count: ${formatNumber(target.latencyData.count)}
                    </div>
                ` : '<p class="text-sm text-gray-500 mb-3">Latency: N/A</p>'}
                <div class="mb-1 text-xs font-medium">Success/Failure Ratio (${formatNumber(totalCompleted)} completed):</div>
                <div class="progress-bar-container mb-3">
                    <div class="progress-bar progress-bar-success" style="width: ${successPercentage.toFixed(1)}%;" title="Success: ${successPercentage.toFixed(1)}%">${successPercentage >= 10 ? successPercentage.toFixed(1) + '%' : ''}</div>
                    <div class="progress-bar progress-bar-failure" style="width: ${failurePercentage.toFixed(1)}%;" title="Failure: ${failurePercentage.toFixed(1)}%">${failurePercentage >= 10 ? failurePercentage.toFixed(1) + '%' : ''}</div>
                </div>
                <details class="text-sm">
                    <summary class="cursor-pointer text-blue-600 hover:underline">Status Codes</summary>
                    <ul class="mt-2 list-disc list-inside pl-2">
                        ${Object.entries(target.statusCodeCounts || {}).map(([code, count]) => `<li>${code}: ${formatNumber(count)}</li>`).join('') || '<li class="text-gray-500">No status code data.</li>'}
                    </ul>
                </details>
            `;
            metricsContainer.appendChild(card);
        });
    }

    function formatNumber(num, decimalPlaces = 0) {
        if (num === null || num === undefined) return 'N/A';
        return Number(num).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });
    }

    function showMessage(text, type = 'info') {
        messageArea.textContent = text;
        messageArea.className = 'mt-4 text-sm p-3 rounded-md transition-opacity duration-300 opacity-100';
        if (type === 'error') messageArea.classList.add('bg-red-100', 'text-red-700');
        else if (type === 'success') messageArea.classList.add('bg-green-100', 'text-green-700');
        else messageArea.classList.add('bg-blue-100', 'text-blue-700');
        setTimeout(() => { messageArea.classList.remove('opacity-100'); messageArea.classList.add('opacity-0');}, 4700);
         setTimeout(() => { messageArea.textContent = ''; messageArea.className = 'mt-4 text-sm';}, 5000);
    }

    startButton.addEventListener('click', async () => {
        showMessage('Starting test...', 'info');
        try {
            const response = await fetch('/api/loadtest/start', { method: 'POST' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || `HTTP error! status: ${response.status}`);
            showMessage(data.message || 'Test started successfully.', 'success');
            if(data.runId) currentRunIdLabel.textContent = data.runId;
            await updateTestRunningStatus();
            fetchMetrics();
        } catch (error) {
            console.error('Error starting test:', error);
            showMessage(`Error starting test: ${error.message}`, 'error');
            await updateTestRunningStatus();
        }
    });

    stopButton.addEventListener('click', async () => {
        showMessage('Stopping test...', 'info');
        try {
            const response = await fetch('/api/loadtest/stop', { method: 'POST' });
            const data = await response.json();
             if (!response.ok) throw new Error(data.message || `HTTP error! status: ${response.status}`);
            showMessage(data.message || 'Test stopped successfully.', 'success');
            await updateTestRunningStatus();
        } catch (error) {
            console.error('Error stopping test:', error);
            showMessage(`Error stopping test: ${error.message}`, 'error');
            await updateTestRunningStatus();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetchTestConfig(); // Fetch and display config on load
        updateTestRunningStatus();
        fetchMetrics();
        statusInterval = setInterval(updateTestRunningStatus, 3000);
        metricsInterval = setInterval(fetchMetrics, 5000);
    });

    window.addEventListener('beforeunload', () => {
        if (statusInterval) clearInterval(statusInterval);
        if (metricsInterval) clearInterval(metricsInterval);
    });
</script>
</body>
</html>
